/* -----------------------------------------------------------------------------
| 第17回若年者ものづくり競技大会「電子回路組立て」職種
| 共通関数Cソースファイル
| ファイル名 [ common_func.c ] 
----------------------------------------------------------------------------- */

/* ---------------------- ヘッダファイルのインクルード ---------------------- */
#include <p18f4620.h>
#include "main.h"
#include "move.h"
#include "common_func.h"
#include "glcdlib_c18_v03.h"

/* --------------------------- グローバル変数宣言--------------------------- */
extern unsigned int red_data;							/*赤LEDデータ格納用*/
extern unsigned int green_data;							/*緑LEDデータ格納用*/
extern unsigned int blue_data;							/*青LEDデータ格納用*/
extern signed int rotary_cnt;							/*ロータリーSW回転数カウント*/
extern unsigned char sw_cnt;							/*SW1チャタリング検知用*/
extern unsigned int cnt_10ms;							/*10msカウンタ*/
extern unsigned int cnt_100ms;							/*100msカウンタ*/
extern unsigned int mode;								/*現在モード状態*/
extern unsigned int old_mode;							/*過去モード状態*/
extern union flag flg;									/*各種フラグ管理用*/

/* 数字データ */
const rom char num_dat[88] = {
0x00,0x3e,0x41,0x41,0x41,0x41,0x3e,0x00,				/* 0x30 '０' */
0x00,0x00,0x42,0x7f,0x40,0x00,0x00,0x00,				/* 0x31 '１' */
0x00,0x62,0x51,0x51,0x49,0x49,0x46,0x00,				/* 0x32 '２' */
0x00,0x22,0x41,0x49,0x49,0x49,0x36,0x00,				/* 0x33 '３' */
0x00,0x30,0x28,0x24,0x22,0x7f,0x20,0x00,				/* 0x34 '４' */
0x00,0x2f,0x45,0x45,0x45,0x45,0x39,0x00,				/* 0x35 '５' */
0x00,0x3e,0x49,0x49,0x49,0x49,0x32,0x00,				/* 0x36 '６' */
0x00,0x01,0x01,0x61,0x19,0x05,0x03,0x00,				/* 0x37 '７' */
0x00,0x36,0x49,0x49,0x49,0x49,0x36,0x00,				/* 0x38 '８' */
0x00,0x26,0x49,0x49,0x49,0x49,0x3e,0x00,				/* 0x39 '９' */
0x08,0x08,0x08,0x42,0x7f,0x40,0x00,0x00					/* 0x2d '-1' */
};

/* 定型文データ */
const rom char message1[72] = {							/* HARD_CHECK */
0x47,0x00,0x7f,0x08,0x08,0x08,0x08,0x7f,
0x00,0x60,0x18,0x16,0x11,0x16,0x18,0x60,
0x00,0x7f,0x09,0x09,0x19,0x29,0x46,0x00,
0x7f,0x41,0x41,0x41,0x22,0x1c,0x00,0x40,
0x40,0x40,0x40,0x40,0x40,0x00,0x1c,0x22,
0x41,0x41,0x41,0x22,0x00,0x7f,0x08,0x08,
0x08,0x08,0x7f,0x00,0x7f,0x49,0x49,0x49,
0x49,0x41,0x00,0x1c,0x22,0x41,0x41,0x41,
0x22,0x00,0x7f,0x10,0x08,0x14,0x22,0x41
};
const rom char message2[55] = {							/* move_mode */
0x36,0x00,0x7c,0x04,0x78,0x04,0x78,0x00,
0x38,0x44,0x44,0x44,0x38,0x00,0x0c,0x30,
0x40,0x30,0x0c,0x00,0x38,0x54,0x54,0x54,
0x18,0x00,0x40,0x40,0x40,0x40,0x40,0x00,
0x7c,0x04,0x78,0x04,0x78,0x00,0x38,0x44,
0x44,0x44,0x38,0x00,0x38,0x44,0x44,0x48,
0x7f,0x00,0x38,0x54,0x54,0x54,0x18
};
const rom char message3[32] = {							/* X_axis */
0x1f,0x41,0x22,0x14,0x08,0x14,0x22,0x41,
0x00,0x08,0x08,0x08,0x00,0x20,0x54,0x54,
0x54,0x78,0x00,0x44,0x28,0x10,0x28,0x44,
0x00,0x7d,0x00,0x48,0x54,0x54,0x54,0x24
};
const rom char message4[32] = {							/* Y_axis */
0x1f,0x01,0x02,0x04,0x78,0x04,0x02,0x01,
0x00,0x08,0x08,0x08,0x00,0x20,0x54,0x54,
0x54,0x78,0x00,0x44,0x28,0x10,0x28,0x44,
0x00,0x7d,0x00,0x48,0x54,0x54,0x54,0x24
};
const rom char message5[32] = {							/* Z_axis */
0x1f,0x00,0x41,0x61,0x51,0x49,0x45,0x43,
0x00,0x08,0x08,0x08,0x00,0x20,0x54,0x54,
0x54,0x78,0x00,0x44,0x28,0x10,0x28,0x44,
0x00,0x7d,0x00,0x48,0x54,0x54,0x54,0x24
};
const rom char message6[97] = {							/* JYAKUMONO 17th */
0x60,0x00,0x20,0x40,0x40,0x40,0x40,0x3f,
0x00,0x01,0x02,0x04,0x78,0x04,0x02,0x01,
0x00,0x60,0x18,0x16,0x11,0x16,0x18,0x60,
0x00,0x7f,0x10,0x08,0x14,0x22,0x41,0x00,
0x3f,0x40,0x40,0x40,0x40,0x3f,0x00,0x7f,
0x02,0x0c,0x30,0x0c,0x02,0x7f,0x00,0x1c,
0x22,0x41,0x41,0x22,0x1c,0x00,0x7f,0x02,
0x04,0x08,0x10,0x7f,0x00,0x1c,0x22,0x41,
0x41,0x22,0x1c,0x00,0x00,0x00,0x00,0x00,
0x00,0x42,0x7f,0x40,0x00,0x00,0x01,0x01,
0x61,0x19,0x05,0x03,0x00,0x04,0x3e,0x44,
0x44,0x20,0x00,0x7f,0x08,0x04,0x04,0x78
};
const rom char message7[89] = {							/* HardCheck_Mode */
0x58,0x00,0x7f,0x08,0x08,0x08,0x08,0x7f,	
0x00,0x20,0x54,0x54,0x54,0x78,0x00,0x7c,
0x08,0x04,0x04,0x08,0x00,0x38,0x44,0x44,
0x48,0x7f,0x00,0x1c,0x22,0x41,0x41,0x41,
0x22,0x00,0x7f,0x08,0x04,0x04,0x78,0x00,
0x38,0x54,0x54,0x54,0x18,0x00,0x38,0x44,
0x44,0x44,0x28,0x00,0x7f,0x10,0x28,0x44,
0x00,0x40,0x40,0x40,0x40,0x40,0x40,0x00,
0x7f,0x02,0x0c,0x30,0x0c,0x02,0x7f,0x00,
0x38,0x44,0x44,0x44,0x38,0x00,0x38,0x44,
0x44,0x48,0x7f,0x00,0x38,0x54,0x54,0x54,
0x18
};
const rom char message8[59] = {							/* Move_Mode */
0x3a,0x7f,0x02,0x0c,0x30,0x0c,0x02,0x7f,
0x00,0x38,0x44,0x44,0x44,0x38,0x00,0x0c,
0x30,0x40,0x30,0x0c,0x00,0x38,0x54,0x54,
0x54,0x18,0x00,0x40,0x40,0x40,0x40,0x40,
0x40,0x00,0x7f,0x02,0x0c,0x30,0x0c,0x02,
0x7f,0x00,0x38,0x44,0x44,0x44,0x38,0x00,
0x38,0x44,0x44,0x48,0x7f,0x00,0x38,0x54,
0x54,0x54,0x18
};

/* -----------------------------------------------------------------------------
/* SW1プッシュ操作検出
----------------------------------------------------------------------------- */
void sw1_check(void)
{
	/*押してない状態*/
	if (SW1 == 1)
	{
		if ((flg.sw1_flag == 1) && (sw_cnt >= 2))
		{
			/*次のモードへ*/
			mode++;

			/*カウンタ・フラグのクリア*/
			flg.sw1_flag = 0;
		}

	}
	/*押してる状態*/
	else
	{
		flg.sw1_flag = 1;								/*SW1押下検知フラグON*/
		sw_cnt = 0;
	}
}

/* -----------------------------------------------------------------------------
/* モード初期化
----------------------------------------------------------------------------- */
void mode_init(void)
{
	flg.all_flag = 0;									/*フラグのクリア*/
	BZ_CON = BZ_OFF;									/*ブザーOFF*/
	ROTARY_LED = 0;										/*ロータリーSW LED 消灯*/
	rotary_cnt = 0;
	cnt_10ms = 0;
	barled_clear();										/*バーLED全消灯*/
	GLCD_ClearScreen();									/*グラフィックLCDクリア*/
}
                       
/* -----------------------------------------------------------------------------
/* バーLED全消去
----------------------------------------------------------------------------- */
void barled_clear(void)
{
	red_data = 0x0000;
	green_data = 0x0000;
	blue_data = 0x0000;
}

/* -----------------------------------------------------------------------------
/* グラフィックLCDバーグラフ表示
----------------------------------------------------------------------------- */
void glcd_bar(unsigned char page,unsigned char start,unsigned char stop)
{
	unsigned char x_pos = 0;
	GLCD_SetDisp(1);									/*Disp指定*/
	GLCD_SetLine(0);									/*Line指定*/
	GLCD_SetPage(page);									/*Page指定*/
	GLCD_SetColumn(0);									/*Column指定*/
	for (x_pos = 0; x_pos < 128; x_pos++)
	{
		if (x_pos == 64)
		{
			GLCD_SetDisp(0);							/*Disp指定*/
			GLCD_SetLine(0);							/*Line指定*/
			GLCD_SetPage(page);							/*Page指定*/
			GLCD_SetColumn(0);							/*Column指定*/
		}
		if ((start <= x_pos) && (x_pos <= stop))
		{
			GLCD_WriteDisplayData(0xff);				/*黒データ表示*/
		}
		else
		{
			GLCD_WriteDisplayData(0x00);				/*白データ表示*/
		}
	}
}

/* -----------------------------------------------------------------------------
/* グラフィックLCD定型文表示
----------------------------------------------------------------------------- */
void glcd_message(unsigned char page,unsigned char num)
{
	unsigned char x_pos = 0;
	unsigned char max_x = 0;
	rom char *m_pos[10];
	
	/* 定型文のアドレス取得 */
	m_pos[0] = message1;
	m_pos[1] = message2;
	m_pos[2] = message3;
	m_pos[3] = message4;
	m_pos[4] = message5;
	m_pos[5] = message6;
	m_pos[6] = message7;
	m_pos[7] = message8;
	
	max_x = *m_pos[num];
		
	GLCD_SetDisp(1);									/*Disp指定*/
	GLCD_SetLine(0);									/*Line指定*/
	GLCD_SetPage(page);									/*Page指定*/
	GLCD_SetColumn(0);									/*Column指定*/
	for (x_pos = 0; x_pos < max_x; x_pos++)
	{
		if (x_pos == 64)
		{
			GLCD_SetDisp(0);							/*Disp指定*/
			GLCD_SetLine(0);							/*Line指定*/
			GLCD_SetPage(page);							/*Page指定*/
			GLCD_SetColumn(0);							/*Column指定*/
		}
		GLCD_WriteDisplayData(*(m_pos[num] + x_pos + 1));
	}	
}

/* -----------------------------------------------------------------------------
/* グラフィックLCD数字表示
----------------------------------------------------------------------------- */
void glcd_write_num(unsigned char page,unsigned char address,unsigned char ascii)
{
	unsigned char x_pos= 0;
	unsigned char d_pos = 0;
	unsigned char num = 0;

	/*数字表示データ判断*/
	if ((ascii >= 0x30) && (ascii <= 0x39))
	{
		num = ascii & 0x0f;
	}
	else
	{
		if (ascii == 0x2d)
		{
			num = 10;
		}
		else
		{
			return;
		}
	}
	x_pos = address;
	if (x_pos > 63)
	{
		GLCD_SetDisp(0);								/*Disp指定*/
		GLCD_SetLine(0);								/*Line指定*/
		GLCD_SetPage(page);								/*Page指定*/
		GLCD_SetColumn(x_pos);							/*Column指定*/
	}
	else
	{
		GLCD_SetDisp(1);								/*Disp指定*/
		GLCD_SetLine(0);								/*Line指定*/
		GLCD_SetPage(page);								/*Page指定*/
		GLCD_SetColumn(x_pos - 64);						/*Column指定*/
	}
	for (d_pos = 0; d_pos < 8; d_pos++)
	{
		if ((x_pos + d_pos) == 64)
		{
			GLCD_SetDisp(0);							/*Disp指定*/
			GLCD_SetLine(0);							/*Line指定*/
			GLCD_SetPage(page);							/*Page指定*/
			GLCD_SetColumn(0);							/*Column指定*/
		}
		//データ表示
		GLCD_WriteDisplayData(num_dat[(num * 8) + d_pos]);
	}	
}

